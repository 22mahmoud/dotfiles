#!/bin/zsh

# ─────────────────────────────────────────────────────────────
# Symbols
# ─────────────────────────────────────────────────────────────
typeset -gA GITSTATUS_SYMBOLS=(
  [ahead]='⇡'
  [behind]='⇣'
  [push_ahead]='⇢'
  [push_behind]='⇠'
  [stash]='*'
  [staged]='+'
  [unstaged]='!'
  [untracked_files]='?'
  [merge_conflict]='~'
  [separator]=' '
)

# Cached separator for faster repeated use
typeset -g GIT_SEP="${GITSTATUS_SYMBOLS[separator]}"

# ─────────────────────────────────────────────────────────────
# Colors
# ─────────────────────────────────────────────────────────────
typeset -gA GITSTATUS_COLORS=(
  [path]='%F{blue}'
  [prompt_success]='%F{green}'
  [prompt_error]='%F{red}'
  [branch]='%F{magenta}'
  [clean]='%F{green}'
  [modified]='%F{yellow}'
  [untracked]='%F{blue}'
  [conflicted]='%F{red}'
  [stash]='%F{cyan}'
)

typeset -g RESET='%f'

# ─────────────────────────────────────────────────────────────
# Configuration
# ─────────────────────────────────────────────────────────────
typeset -gi GITSTATUS_MAX_BRANCH_LENGTH=32

# ─────────────────────────────────────────────────────────────
# Shortcut function for git-status tokens
# ─────────────────────────────────────────────────────────────
gsf() {
  local symbol="$1"
  local count="$2"
  local color="$3"
  (( count > 0 )) && printf '%s%s%s%s' "$GIT_SEP" "${GITSTATUS_COLORS[$color]}" "${GITSTATUS_SYMBOLS[$symbol]}" "$count"
}

# ─────────────────────────────────────────────────────────────
# Python/virtualenv prompt component
# ─────────────────────────────────────────────────────────────
export VIRTUAL_ENV_DISABLE_PROMPT=1

venv_prompt() {
  [[ $VIRTUAL_ENV ]] || return
  printf ' %F{cyan}(%s)%f' "${VIRTUAL_ENV:t}"
}

# ─────────────────────────────────────────────────────────────
# Branch truncation
# ─────────────────────────────────────────────────────────────
gs_fb() {
  local raw="$1"
  local icon=" "
  local full="${icon}${raw}"

  if (( ${#raw} > GITSTATUS_MAX_BRANCH_LENGTH )); then
    local half=$(( (GITSTATUS_MAX_BRANCH_LENGTH - 1) / 2 ))
    printf '%s…%s' "${raw[1,$half]}" "${raw[-$half,-1]}"
  else
    printf '%s' "$full"
  fi
}

# ─────────────────────────────────────────────────────────────
# Gitstatus update hook
# ─────────────────────────────────────────────────────────────
gitstatus_prompt_update() {
  emulate -L zsh
  typeset -g GITSTATUS_PROMPT=''
  typeset -gi GITSTATUS_PROMPT_LEN=0

  # Skip work when outside git repos
  [[ -d .git || -d ../.git ]] || return

  # Query daemon
  gitstatus_query 'MY' || { GITSTATUS_PROMPT=''; return; }
  [[ $VCS_STATUS_RESULT == 'ok-sync' ]] || return

  local p=" on ${GITSTATUS_COLORS[branch]}"

  # Determine branch/tag/commit
  if [[ $VCS_STATUS_LOCAL_BRANCH ]]; then
    p+="$(gs_fb "$VCS_STATUS_LOCAL_BRANCH")"
  elif [[ $VCS_STATUS_TAG ]]; then
    p+="#$(gs_fb "$VCS_STATUS_TAG")"
  else
    p+=" @${VCS_STATUS_COMMIT[1,8]}"
  fi

  # Remote status
  if (( VCS_STATUS_COMMITS_BEHIND || VCS_STATUS_COMMITS_AHEAD )); then
    p+="$GIT_SEP"
    (( VCS_STATUS_COMMITS_BEHIND )) && p+=$(gsf behind "$VCS_STATUS_COMMITS_BEHIND" clean)
    (( VCS_STATUS_COMMITS_AHEAD )) && p+=$(gsf ahead "$VCS_STATUS_COMMITS_AHEAD" clean)
  fi

  # Push remote status
  if (( VCS_STATUS_PUSH_COMMITS_BEHIND || VCS_STATUS_PUSH_COMMITS_AHEAD )); then
    p+="$GIT_SEP"
    (( VCS_STATUS_PUSH_COMMITS_BEHIND )) && p+=$(gsf push_behind "$VCS_STATUS_PUSH_COMMITS_BEHIND" clean)
    (( VCS_STATUS_PUSH_COMMITS_AHEAD )) && p+=$(gsf push_ahead "$VCS_STATUS_PUSH_COMMITS_AHEAD" clean)
  fi

  # Repository status
  (( VCS_STATUS_STASHES ))          && p+=$(gsf stash "$VCS_STATUS_STASHES" stash)
  [[ $VCS_STATUS_ACTION ]]          && p+="$GIT_SEP${GITSTATUS_COLORS[conflicted]}${VCS_STATUS_ACTION}"
  (( VCS_STATUS_NUM_CONFLICTED ))   && p+=$(gsf merge_conflict "$VCS_STATUS_NUM_CONFLICTED" conflicted)
  (( VCS_STATUS_NUM_STAGED ))       && p+=$(gsf staged "$VCS_STATUS_NUM_STAGED" clean)
  (( VCS_STATUS_NUM_UNSTAGED ))     && p+=$(gsf unstaged "$VCS_STATUS_NUM_UNSTAGED" modified)
  (( VCS_STATUS_NUM_UNTRACKED ))    && p+=$(gsf untracked_files "$VCS_STATUS_NUM_UNTRACKED" untracked)

  GITSTATUS_PROMPT="${p}${RESET}"
  GITSTATUS_PROMPT_LEN="${(m)#${${GITSTATUS_PROMPT//\%\%/X}//\%(f|<->F)}}"
}

# ─────────────────────────────────────────────────────────────
# Prompt setup
# ─────────────────────────────────────────────────────────────
prompt_setup() {
  setopt no_prompt_bang prompt_percent prompt_subst
  typeset -g prompt_newline=$'\n%{\r%}'

  gitstatus_stop 'MY' && gitstatus_start -s -1 -u -1 -c -1 -d -1 'MY'

  autoload -Uz add-zsh-hook
  add-zsh-hook precmd gitstatus_prompt_update

  PROMPT=''
  PROMPT+='${prompt_newline}'
  PROMPT+='${GITSTATUS_COLORS[path]}%B%1~%b%f'
  PROMPT+='$(venv_prompt)'
  PROMPT+='$GITSTATUS_PROMPT'
  PROMPT+='${prompt_newline}%(?.${GITSTATUS_COLORS[prompt_success]}.${GITSTATUS_COLORS[prompt_error]})%B%b%f '
}

# Initialize immediately
prompt_setup
