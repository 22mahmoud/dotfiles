#!/usr/bin/env bash
# vim: ft=bash

title="fzf-menu"
class="fzf-menu"

args=()
while [[ $# -gt 0 ]]; do
  case "$1" in
  --title=*)
    title="${1#--title=}"
    shift
    ;;
  --class=*)
    class="${1#--class=}"
    shift
    ;;
  *)
    args+=("$1")
    shift
    ;;
  esac
done

cleanup() {
  rm -rf "$input" "$output"
  kill $! 2>/dev/null
}

input=$(mktemp -u --suffix .fzfmenu.input)
output=$(mktemp -u --suffix .fzfmenu.output)

mkfifo "$input"
mkfifo "$output"

chmod 600 "$input" "$output"

foot \
  --app-id "$class" \
  --title "$title" \
  -e zsh -c "
    cat $input |
    fzf \
      --layout=reverse \
      --prompt='~ ' \
      $(printf -- " '%s'" "${args[@]}" | sed "s/^ ''$//") |
    tee $output
  " 2> >(grep -v "warn:" >&2) &

disown

trap cleanup EXIT INT TERM

cat >"$input"
cat "$output"
