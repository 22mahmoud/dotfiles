#!/usr/bin/env bash
# vim: ft=bash

set -eu
set -o pipefail

c_action=pass
c_is_raw=
c_query=

selection=
selected_user=
selected_id=
fzf_rbw_args="$(mktemp)"

ICON_TITLE="ğŸ”"
ICON_PASS="ğŸ”‘"
ICON_LOGIN="ğŸªª"
ICON_USER="ğŸ‘¤"
ICON_OTP="â±ï¸"
ICON_SYNC="ğŸ”„"
ICON_ENTRY="ğŸ“„"

trap 'rm -f "${fzf_rbw_args}"' EXIT

usage() {
  local status="${1:-1}"

  cat <<EOF
Usage: $(basename "$0") [OPTIONS]

Description:
  This script provides an interactive interface to the Bitwarden CLI (rbw) using fzf.
  You can select an entry from your vault and copy the desired information to the clipboard.

Options:
  -r            Output raw credentials (no clipboard interaction).
  -h            Display this help message and exit.
  -q <TERM>     A predefined query to filter out the search result
  -a <ACTION>   The default action for "Enter",
                available options are pass, user, login, otp [default: pass]

Key Bindings (fzf):
  Ctrl-X   Copy the password to the clipboard.
  Ctrl-L   Copy the login credentials (username + password + OTP) to the clipboard.
  Ctrl-U   Copy the username to the clipboard.
  Ctrl-O   Copy the OTP to the clipboard.
  Ctrl-R   Sync the bitwarden vault store
EOF
  exit "$status"
}

require_cmd() {
  command -v "$1" >/dev/null 2>&1 || {
    printf 'Missing required command: %s\n' "$1" >&2
    exit 1
  }
}

check_dependencies() {
  require_cmd rbw
  require_cmd fzf-menu

  if [[ -z "${c_is_raw}" ]]; then
    require_cmd wl-copy
    require_cmd notify-send
  fi
}

validate_action() {
  case "$c_action" in
  pass | user | login | otp) ;;
  *)
    printf 'Invalid action: %s\n' "$c_action" >&2
    usage 1
    ;;
  esac
}

notify() {
  local emoji="${1:-}"
  local msg="${2:-}"
  local title="Password Manager"

  if [[ -n "$emoji" ]]; then
    title="${emoji} ${title}"
  fi

  notify-send -t 2500 -u low \
    -h string:x-canonical-private-synchronous:"fzf-rbw" \
    "$title" "$msg"
}

clipboard() {
  printf '%s' "$1" | tr -d '\n' | wl-copy
  notify "${3:-}" "$2"
}

unlock() {
  rbw unlocked >/dev/null 2>&1 || rbw unlock
}

fzf_rbw_menu() {
  rbw list --fields id,name,user,folder | fzf-menu --title="${ICON_TITLE} rbw password picker" --class="fzf-menu-rbw" \
    --query "$c_query" \
    --prompt="${ICON_PASS} rbw ~ " \
    --layout=reverse \
    --delimiter '\t' \
    --with-nth=2,3 \
    --tabstop=38 \
    --bind "enter:execute(printf '%s' '${c_action}' > '${fzf_rbw_args}')+accept" \
    --bind "ctrl-l:execute(printf '%s' 'login' > '${fzf_rbw_args}')+accept" \
    --bind "ctrl-u:execute(printf '%s' 'user' > '${fzf_rbw_args}')+accept" \
    --bind "ctrl-x:execute(printf '%s' 'pass' > '${fzf_rbw_args}')+accept" \
    --bind "ctrl-o:execute(printf '%s' 'otp' > '${fzf_rbw_args}')+accept" \
    --bind "ctrl-r:execute(rbw sync && notify-send \"${ICON_SYNC} Password Manager\" \"Successfully synced passwords\")" \
    --preview "echo \"${ICON_ENTRY} Entry: {2}\\n${ICON_USER} Username: {3}\"" \
    --preview-window 'bottom:2:wrap:border-sharp'
}

parse_selection() {
  IFS=$'\t' read -r selected_id _ selected_user <<<"$selection"

  if [[ -z "$selected_id" ]]; then
    printf 'Unable to parse selected entry id\n' >&2
    exit 1
  fi
}

output_result() {
  local value="$1"
  local message="$2"
  local icon="$3"

  if [[ -n "${c_is_raw}" ]]; then
    printf '%s\n' "$value"
    exit 0
  fi

  clipboard "$value" "$message" "$icon"
}

get_pass() {
  local password

  password="$(rbw get "$selected_id")"
  output_result "$password" "Password copied to clipboard." "$ICON_PASS"
}

get_login() {
  local username
  local password
  local otp
  local result

  username="$selected_user"
  password="$(rbw get "$selected_id")"
  otp="$(rbw code "$selected_id" 2>/dev/null || true)"

  result="$username"
  result+=$'\n'
  result+="$password"
  if [[ -n "$otp" ]]; then
    result+=$'\n'
    result+="$otp"
  fi

  if [[ -n "${c_is_raw}" ]]; then
    output_result "$result" "" ""
  fi

  output_result "${result//$'\n'/ }" "Credentials copied to clipboard." "$ICON_LOGIN"
}

get_user() {
  local username
  username="$selected_user"
  output_result "$username" "Username copied to clipboard." "$ICON_USER"
}

get_otp() {
  local otp
  otp="$(rbw code "$selected_id" 2>/dev/null || true)"
  output_result "$otp" "OTP copied to clipboard." "$ICON_OTP"
}

main() {
  while getopts ':hrq:a:' opt; do
    case "${opt}" in
    r) c_is_raw=true ;;
    h) usage 0 ;;
    q) c_query="$OPTARG" ;;
    a) c_action="$OPTARG" ;;
    :)
      echo "Option -${OPTARG} requires an argument."
      echo ""
      usage
      ;;
    ?)
      echo "Invalid option: -${OPTARG}."
      echo ""
      usage
      ;;
    *) ;;
    esac
  done

  validate_action
  check_dependencies

  unlock

  local action
  selection="$(fzf_rbw_menu)"

  if [[ -z "$selection" ]]; then
    exit 0
  fi

  parse_selection

  if [[ -f "${fzf_rbw_args}" ]]; then
    action="$(<"${fzf_rbw_args}")"
    rm -f "${fzf_rbw_args}"
  else
    exit 0
  fi

  if [[ -z "$action" ]]; then
    action="$c_action"
  fi

  case "$action" in
  pass) get_pass ;;
  login) get_login ;;
  user) get_user ;;
  otp) get_otp ;;
  *) exit ;;
  esac
}

main "$@"
