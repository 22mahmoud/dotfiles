#!/usr/bin/env bash

set -euo pipefail

CONFIG="${MBSYNCRC:-$HOME/.mbsyncrc}"
LOCKFILE="${XDG_RUNTIME_DIR:-/tmp}/mailsync.lock"

[[ ! -f "$CONFIG" ]] && {
  printf 'mailsync: config not found: %s\n' "$CONFIG" >&2
  exit 1
}

exec {LOCK_FD}>"$LOCKFILE"
if ! flock -n "$LOCK_FD"; then
  printf 'mailsync: another mbsync is running. Waiting...\n' >&2
  flock "$LOCK_FD"
fi

(($# == 0)) && set -- -a
exec mbsync -c "$CONFIG" "$@"
