#!/bin/sh

# c_ prefix stands for config (acts like global state)
c_type=
c_mode="full"

file_name=${REX_FILE_NAME:-$(date '+%y%m%d-%H%M-%S')}
pictures_dir=${REX_PIC_DIR:-$XDG_PICTURES_DIR/screenshots}

usage() {
  while IFS= read -r line; do
    printf '%s\n' "$line"
  done <<-EOF

  rex [ -h | -s | -m ]
    take a screenshot.

  -h    show this help
  -s    take a screenshot
  -m    mode can be either full,f(default), or select,s
EOF
}

while getopts 'hsvgqam:' opt; do
  case "$opt" in
  h)
    usage
    exit 0
    ;;
  m) c_mode="$OPTARG" ;;
  s) c_type="screenshot" ;;
  *)
    usage
    exit 0
    ;;
  esac
done

screenshot() {
  screenshot_path="$pictures_dir/screenshot-$file_name.png"

  case "$c_mode" in
  full | f)
    grim -t png "$screenshot_path"
    ;;
  select | s)
    geom="$(slurp)" || exit 0
    [ -z "$geom" ] && exit 0
    grim -g "$geom" -t png "$screenshot_path"
    ;;
  esac

  [ ! -e "$screenshot_path" ] && exit 1

  wl-copy --type image/png <"$screenshot_path"

  dunstify -i "$screenshot_path" "Rex" "screenshot taken" --action "default,Edit" --action "view,View" | {
    read -r action
    case "$action" in
    "default") satty --filename "$screenshot_path" ;;
    "view") imv "$screenshot_path" ;;
    esac
  } &
}

case "$c_type" in
screenshot) screenshot ;;
esac
