#!/bin/bash

usage() {
  while IFS= read -r line; do
    printf '%s\n' "$line"
  done <<-EOF

  volume [ -i | -d | -t | -h ]
    control volume with notifications

  -h|help     show this help
  -i|inc      increase volume
  -d|dec      decrease volume
  -t|toggle   toggle volume mute/unmute
EOF
}

inc() {
  wpctl set-volume --limit 1.0 @DEFAULT_AUDIO_SINK@ 5%+
}

dec() {
  wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%-
}

toggle() {
  wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle
}

get_volume() {
  local output volume

  output="$(wpctl get-volume @DEFAULT_AUDIO_SINK@)"
  volume="${output#Volume: }"
  volume="${volume%% *}"

  awk -v v="$volume" 'BEGIN { printf "%d", (v * 100) + 0.5 }'
}

get_mute() {
  local output

  output="$(wpctl get-volume @DEFAULT_AUDIO_SINK@)"

  case "$output" in
  *MUTED*) echo true ;;
  *) echo false ;;
  esac
}

get_icon() {
  local volume icon

  volume="$(get_volume)"

  if [ "$(get_mute)" = true ]; then
    icon="audio-volume-muted"
  elif [ "$volume" -gt 70 ]; then
    icon="audio-volume-high"
  elif [ "$volume" -gt 30 ]; then
    icon="audio-volume-medium"
  elif [ "$volume" -gt 0 ]; then
    icon="audio-volume-low"
  else
    icon="audio-volume-muted"
  fi

  echo "$icon"
}

notify() {
  local volume is_muted volume_human icon

  volume="$(get_volume)"
  is_muted="$(get_mute)"
  icon="$(get_icon)"

  volume_human="${volume}%"
  if [ "$is_muted" = true ]; then
    volume_human="${volume}% (muted)"
  fi

  notify-send \
    -t 1500 \
    -i "$icon" \
    -h int:value:"$volume" \
    -h string:x-canonical-private-synchronous:"changeVolume" \
    "Volume: $volume_human"
}

main() {
  case "$1" in
  -h | help) usage ;;
  -i | inc) inc ;;
  -d | dec) dec ;;
  -t | toggle) toggle ;;
  *) exit 0 ;;
  esac

  notify
}

main "$@"
