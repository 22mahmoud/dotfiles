#!/bin/sh

c_socket=/tmp/mpvsocket

notify() {
  if command -v notify-send >/dev/null 2>&1; then
    notify-send \
      -a "mpx" \
      -i "media-playback-start" \
      -u low \
      "$@"
  fi
}

die() {
  notify -u critical "Error" "$*"
  printf >&2 '%s\n' "$*"
  exit 1
}

usage() {
  while IFS= read -r line; do
    printf '%s\n' "$line"
  done <<-EOF

  ${0##*/} [ -h | -a {url} ]
    a command-line utility wrapper to use mpv w/ IPC

  -h            show this help
  -a  {url}     add file or link to the mpv queue
EOF
  exit 0
}

check_deps() {
  for cmd in mpv socat; do
    command -v "$cmd" >/dev/null 2>&1 || die "Missing dependency: $cmd"
  done
}

is_active() {
  [ -S "$c_socket" ] || return 1
  response=$(echo '{ "command": ["get_property", "pid"] }' | socat - "$c_socket" 2>/dev/null)
  [ -n "$response" ]
}

cleanup_stale_socket() {
  if [ -S "$c_socket" ] && ! is_active; then
    rm -f "$c_socket"
  fi
}

get_file_name() {
  [ -z "$1" ] && die "Error: No file or URL provided"

  case "$1" in
  https://* | http://*) file_name="$1" ;;
  *)
    if [ -e "$(realpath "$1" 2>/dev/null)" ]; then
      file_name=$(realpath "$1")
    else
      die "Error: File not found: $1"
    fi
    ;;
  esac

  echo "$file_name"
}

add() {
  [ -z "$1" ] && die "Error: Nothing to add"

  # Get display name for notification
  case "$1" in
  http://* | https://*) display_name="$1" ;;
  *) display_name="${1##*/}" ;;
  esac

  if is_active; then
    printf 'loadfile "%s" append-play\n' "$1" |
      socat - "$c_socket" >/dev/null 2>&1 ||
      die "Error: Failed to add to playlist"
    notify "Added to playlist" "$display_name"
  else
    mpv --no-terminal --really-quiet --idle=once \
      --input-ipc-server="$c_socket" "$1" &
    notify "Now playing" "$display_name"
  fi
}

main() {
  check_deps
  cleanup_stale_socket

  case "$1" in
  -h | --help) usage ;;
  -a)
    [ -z "$2" ] && die "Error: -a requires a file or URL"
    add "$(get_file_name "$2")"
    ;;
  "") usage ;;
  *) die "Error: Unknown option: $1" ;;
  esac
}

main "$@"
