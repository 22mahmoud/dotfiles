#!/bin/bash

C_RICINIG="$XDG_CONFIG_HOME/ricing"
c_nvim="$C_RICINIG/colorscheme.lua"
c_zshrc="$C_RICINIG/theme.zsh"
c_tmux="$C_RICINIG/theme-tmux.conf"
c_qutebrowser="$C_RICINIG/theme-qutebrowser.py"
c_delta="$C_RICINIG/delta-theme.gitconfig"
c_lazygit="$C_RICINIG/lazygit-theme.yml"
c_zathura="$C_RICINIG/zathura-theme"
c_dunst="$C_RICINIG/theme.dunstrc"
c_ghostty="$C_RICINIG/ghostty-theme"
c_alacritty="$C_RICINIG/alacritty-theme.toml"
c_foot="$C_RICINIG/foot-theme.ini"
c_waybar="$C_RICINIG/waybar.css"

themes="base16-gruvbox-dark-hard
base16-default-dark
base16-ia-dark
base16-monokai
base16-ashes
base16-dracula
base16-gruvbox-light-soft
base16-nord
base16-oceanicnext
base16-onedark
base16-outrun-dark
base16-phd
base16-porple
base16-solarflare
base16-solarized-dark
base16-tomorrow-night
base16-twilight
base16-oxocarbon-dark"

pick_theme() {
  local selected

  if [ -n "${1:-}" ]; then
    selected="$1"
  else
    selected="$(echo "$themes" | fzf-menu --prompt='ðŸŽ¨ Choose a theme ~ ')"
  fi

  [ -n "$selected" ] || exit 0

  if ! echo "$themes" | grep -q "^$selected$"; then
    echo "Error: Theme '$selected' not found in selected themes list"
    exit 1
  fi

  theme_name="$selected"
}

update_tmux() {
  {
    echo "source-file \"\$XDG_DATA_HOME/tmux/plugins/tinted-tmux/colors/$theme_name.conf\""
    echo "set -g @colors-base16 '${theme_name#base16-}'"
  } >"$c_tmux"

  [ "$(pidof tmux)" ] && tmux source-file "$XDG_CONFIG_HOME/tmux/tmux.conf"
}

update_nvim() {
  echo "vim.cmd[[silent! colorscheme $theme_name]]" >"$c_nvim"
  nvr -c ":silent! colorscheme $theme_name<cr>"
}

update_zsh() {
  {
    echo "source \"$HOME/.local/src/tinted-fzf/sh/$theme_name.sh\""
    echo
    echo 'export BAT_THEME="base16"'
  } >"$c_zshrc"

  killall -u "$(whoami)" -s USR1 zsh
}

update_qutebrowser() {
  {
    echo "config.source('$XDG_CONFIG_HOME/qutebrowser/base16-qutebrowser/themes/minimal/$theme_name.config.py')"
    echo 'c.colors.webpage.bg = "white"'
  } >"$c_qutebrowser"

  [ "$(pgrep -f qutebrowser)" ] && qutebrowser :config-source
}

update_wallpaper() {
  rwall
}

update_lazygit() {
  cp "$HOME/.local/src/base16-lazygit/colors/$theme_name.yml" "$c_lazygit"
}

update_zathura() {
  cp "$HOME/.local/src/base16-zathura/build_schemes/recolors/$theme_name.config" "$c_zathura"
}

update_dunst() {
  pkill -9 dunst
  cp "$HOME/.local/src/base16-dunst/themes/$theme_name.dunstrc" "$c_dunst"

  local frame_color
  local highlight_color

  frame_color="$(grep -m 1 "frame_color = \"#" "$c_dunst" | awk -F'"' '{print $2}')"
  highlight_color="$(grep -m 1 "highlight = \"#" "$c_dunst" | awk -F'"' '{print $2}')"

  if [ -z "$highlight_color" ]; then
    sed -i "1i [global]\n\thighlight = \"$frame_color\"\n" "$c_dunst"
  fi

  start-dunst
}

update_delta() {
  {
    echo "[delta]"
    echo "  syntax-theme = base16"
  } >"$c_delta"
}

update_alacritty() {
  {
    echo "[general]"
    echo "import = [\"$HOME/.local/src/tinted-terminal/themes/alacritty/$theme_name.toml\"]"
  } >"$c_alacritty"
}

update_foot() {
  cp "$HOME/.local/src/tinted-terminal/themes/foot/$theme_name.ini" "$c_foot"
}

update_waybar() {
  local src="$HOME/.local/src/base16-waybar/colors/$theme_name.css"
  cp "$src" "$c_waybar"

  pkill -SIGUSR2 waybar
}

update_ghostty() {
  echo "theme = $HOME/.local/src/tinted-terminal/themes/ghostty/$theme_name" >"$c_ghostty"
}

main() {
  pick_theme "${1:-}"

  update_qutebrowser &
  update_zsh &
  update_delta &
  update_tmux &
  update_nvim &
  update_lazygit &
  update_zathura &
  update_dunst &
  update_ghostty &
  update_alacritty &
  update_foot &
  update_waybar &
  update_wallpaper &
}

main "$@"
